var Q=[{id:"total",label:"Total",start:1,end:1/0},{id:"opening",label:"Opening (0-60)",start:1,end:60},{id:"middle",label:"Middle (61-150)",start:61,end:150},{id:"end",label:"End (151+)",start:151,end:1/0}],J=.5,o={playerId:null,playerName:null,playerRank:null,playerAvatar:null,games:[],analyses:new Map,analysisErrors:new Map,selectedGameId:null,jwt:null,viewerPhase:"all",viewerQuality:null,viewerReport:null,viewerScores:[],viewerWinrates:[],viewerMovesLength:0,editorListenerTarget:null,viewerNodesByMove:null};var m={homeView:document.getElementById("homeView"),viewerView:document.getElementById("viewerView"),playerInput:document.getElementById("playerInput"),filterRanked:document.getElementById("filterRanked"),filterFree:document.getElementById("filterFree"),loadPlayer:document.getElementById("loadPlayer"),clearSession:document.getElementById("clearSession"),profileName:document.getElementById("profileName"),profileMeta:document.getElementById("profileMeta"),profileAvatar:document.getElementById("profileAvatar"),profileStats:document.getElementById("profileStats"),status:document.getElementById("status"),gamesStatus:document.getElementById("gamesStatus"),analysisSummary:document.getElementById("analysisSummary"),phaseReport:document.getElementById("phaseReport"),scoreDistribution:document.getElementById("scoreDistribution"),winrateDistribution:document.getElementById("winrateDistribution"),gamesTable:document.getElementById("gamesTable"),backToHome:document.getElementById("backToHome"),viewerGameTitle:document.getElementById("viewerGameTitle"),viewerGameMeta:document.getElementById("viewerGameMeta"),viewerGameResult:document.getElementById("viewerGameResult"),viewerGameReport:document.getElementById("viewerGameReport"),analysisTabs:document.getElementById("analysisTabs"),qualityTable:document.getElementById("qualityTable"),currentScore:document.getElementById("currentScore"),currentWinrate:document.getElementById("currentWinrate")};function K(e){if(!e)return null;let t=e.trim();if(!t)return null;if(/^\d+$/.test(t))return t;let r=t.match(/player\/(\d+)|user\/view\/(\d+)/);return r?r[1]||r[2]:null}function k(e){return typeof e!="number"||!Number.isFinite(e)?null:e>=30?`${Math.max(1,Math.round(e-29))}d`:`${Math.max(1,Math.round(30-e))}k`}function b(e){return e?.username||e?.name||e?.display_name||"Unknown"}function S(e,t){let r=e.black??e.players?.black?.id,a=e.white??e.players?.white?.id;return String(r)===String(t)?"black":String(a)===String(t)?"white":null}function R(e,t){let r=e.black??e.players?.black?.id,a=e.white??e.players?.white?.id,n=String(r)===String(t),s=String(a)===String(t);if(!n&&!s)return"N/A";let c=n?e.black_lost:e.white_lost;return typeof c=="boolean"?c?"L":"W":"N/A"}function E(e){let t=b(e.players?.black),r=b(e.players?.white);return`${t} vs ${r}`}function Y(e){if(!e)return"-";let t=new Date(e);return Number.isNaN(t.getTime())?"-":t.toISOString().slice(0,10)}function X(e,t){let r=S(e,t);return r==="black"?e.players?.white||null:r==="white"&&e.players?.black||null}function Z(e,t){let r=R(e,t),a=(e.outcome||"").toLowerCase(),n=a.match(/([0-9]+(?:\\.[0-9]+)?)/),s=n?n[1]:null,c=a.includes("resign"),i=a.includes("time"),l=r==="W"?"W":r==="L"?"L":"N";return c?`${l} + R`:i?`${l} + T`:s?`${l} + ${s}`:`${l} + ?`}function I(e){try{let t=sessionStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.warn("Session parse failed",t),null}}function P(e,t){try{sessionStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Session save failed",r)}}function ee(){Object.keys(sessionStorage).forEach(e=>{(e.startsWith("ogs.games.")||e.startsWith("ogs.ai.")||e.startsWith("ogs.review."))&&sessionStorage.removeItem(e)})}function $(){return{moves:0,accurate:0,scoreLossTotal:0,winrateLossTotal:0,mistakes:{total:0,severe:0,blunders:0},scoreBuckets:W(),winrateBuckets:$e()}}function Se(){return{total:$(),opening:$(),middle:$(),end:$()}}function te(e,t,r){e.moves+=1,e.scoreLossTotal+=t,t<=J&&(e.accurate+=1);let a=G(t);if(e.scoreBuckets[a.id]+=1,typeof r=="number"){e.winrateLossTotal+=r;let n=xe(r*100);e.winrateBuckets[n.id]+=1,r>=.1&&(e.mistakes.total+=1),r>=.2&&(e.mistakes.severe+=1),r>=.4&&(e.mistakes.blunders+=1)}}function x(e){let t=e.moves?e.accurate/e.moves*100:0,r=e.moves?e.scoreLossTotal/e.moves:0,a=e.moves?e.winrateLossTotal/e.moves*100:0;return{moves:e.moves,accuracy:Number(t.toFixed(1)),avgLoss:Number(r.toFixed(2)),avgWinLoss:Number(a.toFixed(2)),mistakes:e.mistakes,scoreBuckets:e.scoreBuckets,winrateBuckets:e.winrateBuckets}}function re(e){return e<=60?"opening":e<=150?"middle":"end"}function ae(e,t){let r=(t||"black").toLowerCase(),a=e%2===1;return r==="white"?a?"white":"black":a?"black":"white"}function ne(e,t){let r=new Array(t).fill(null);if(!Array.isArray(e)||e.length<2)return r;let a=e.length>=t+1;for(let n=1;n<=t;n+=1){let s=a?n-1:n-2,c=a?n:n-1;if(s<0||c>=e.length)continue;let i=e[s],l=e[c];typeof i!="number"||typeof l!="number"||(r[n-1]=Math.abs(l-i))}return r}var B=[{id:"best",label:"Best (<=0.5)",max:.5,color:"#3b82f6"},{id:"good",label:"Good (0.5-1.5)",max:1.5,color:"#22c55e"},{id:"ok",label:"Ok (1.5-3)",max:3,color:"#facc15"},{id:"bad",label:"Bad (3-6)",max:6,color:"#ef4444"},{id:"blunder",label:"Blunder (6-12+)",max:1/0,color:"#a855f7"}];function W(){return Object.fromEntries(B.map(e=>[e.id,0]))}var T=[{id:"lt1",label:"<1%",max:1},{id:"1-3",label:"1-3%",max:3},{id:"3-6",label:"3-6%",max:6},{id:"6-12",label:"6-12%",max:12},{id:"12-24",label:"12-24%",max:24},{id:"24+",label:"24%+",max:1/0}];function $e(){return Object.fromEntries(T.map(e=>[e.id,0]))}function G(e){for(let t of B)if(e<=t.max)return t;return B[B.length-1]}function xe(e){for(let t of T)if(e<=t.max)return t;return T[T.length-1]}function se(e){let t=e?.metadata?.game_state,r=t?.moves?.length||e?.scoreLosses?.length||0,a=t?.initial_player||"black",s=Object.fromEntries(["all","opening","middle","end"].map(c=>[c,{black:W(),white:W()}]));for(let c=1;c<=r;c+=1){let i=e.scoreLosses?.[c-1];if(i==null)continue;let l=ae(c,a),d=re(c),u=G(i);s.all[l][u.id]+=1,s[d][l][u.id]+=1}return s}function Ae(e,t){let r=new Array(t).fill(null);if(!Array.isArray(e)||e.length<2)return r;let a=e.length>=t+1;for(let n=1;n<=t;n+=1){let s=a?n-1:n-2,c=a?n:n-1;if(s<0||c>=e.length)continue;let i=e[s],l=e[c];typeof i!="number"||typeof l!="number"||(r[n-1]=Math.abs(l-i))}return r}function _(e,t,r){let a=S(e,r),n=Se();if(!t||!a)return null;let s=t.metadata?.game_state,c=s?.moves?.length||t.scoreLosses.length,i=s?.initial_player||"black",l=Ae(t.metadata?.win_rates,c);for(let u=1;u<=c;u+=1){let f=t.scoreLosses[u-1],p=l[u-1];if(f==null||ae(u,i)!==a)continue;let v=re(u);te(n.total,f,p),te(n[v],f,p)}let d={total:x(n.total),opening:x(n.opening),middle:x(n.middle),end:x(n.end)};return{id:e.id,label:E(e),result:R(e,r),playerSide:a,ranked:e.ranked,phases:d,rawPhases:n}}function ie(e,t,r){let a=()=>({games:0,wins:0,losses:0,phases:{total:$(),opening:$(),middle:$(),end:$()}}),n=a(),s=a(),c=a(),i=[];e.forEach(d=>{let u=t.get(d.id),f=_(d,u,r);if(!f)return;i.push(f);let p=f.playerSide==="black"?s:c,y=f.result;[n,p].forEach(v=>{v.games+=1,y==="W"&&(v.wins+=1),y==="L"&&(v.losses+=1),Object.keys(v.phases).forEach(A=>{let h=f.rawPhases[A],w=v.phases[A];w.moves+=h.moves,w.accurate+=h.accurate,w.scoreLossTotal+=h.scoreLossTotal,w.winrateLossTotal+=h.winrateLossTotal,w.mistakes.total+=h.mistakes.total,w.mistakes.severe+=h.mistakes.severe,w.mistakes.blunders+=h.mistakes.blunders,Object.keys(w.scoreBuckets).forEach(L=>{w.scoreBuckets[L]+=h.scoreBuckets[L]||0}),Object.keys(w.winrateBuckets).forEach(L=>{w.winrateBuckets[L]+=h.winrateBuckets[L]||0})})})});function l(d){return{...d,phases:{total:x(d.phases.total),opening:x(d.phases.opening),middle:x(d.phases.middle),end:x(d.phases.end)}}}return{combined:l(n),black:l(s),white:l(c),reports:i}}var N=null,oe=0;async function F(e,t={},r=3){let a=null;for(let n=0;n<r;n+=1){let s=await fetch(e,t);if(s.ok)return s.json();if(s.status===429){a=new Error("Request was throttled."),await new Promise(c=>setTimeout(c,800*(n+1)));continue}a=new Error(`Request failed (${s.status})`);break}throw a||new Error("Request failed")}async function Le(){return o.jwt?o.jwt:Date.now()-oe<8e3?null:(N||(N=(async()=>{try{let t=await F("https://online-go.com/api/v1/ui/config");return o.jwt=t.anon_jwt||null,o.jwt}catch{return oe=Date.now(),o.jwt=null,null}finally{N=null}})()),N)}function Be(e,t,r={}){let a=new URLSearchParams;return a.set("page",String(t)),a.set("page_size",String(r.pageSize||25)),a.set("source","play"),a.set("ended__isnull","false"),a.set("annulled","false"),a.set("ordering","-ended"),r.ranked===!0&&a.set("ranked","true"),r.ranked===!1&&a.set("ranked","false"),`https://online-go.com/api/v1/players/${e}/games/?${a.toString()}`}async function le(e,t,r={}){let a=`ogs.games.${e}.page.${t}.${r.ranked??"all"}.${r.pageSize||25}`,n=I(a);if(n)return n;let s=await F(Be(e,t,r));return P(a,s),s}async function H(e){let t=`ogs.review.${e}`,r=I(t);if(r)return r;let a=await F(`https://online-go.com/api/v1/games/${e}/ai_reviews`),n=Array.isArray(a?.results)?a.results:Array.isArray(a)?a:[];return P(t,n),n}function Ee(e,t){return new Promise((r,a)=>{let n=new WebSocket("wss://ai.online-go.com/"),s=setTimeout(()=>{n.close(),a(new Error("AI review timed out"))},15e3);n.onopen=()=>{t&&n.send(JSON.stringify(["authenticate",{jwt:t,device_id:crypto.randomUUID(),user_agent:navigator.userAgent,language:"en",language_version:"56583ff4aa3a8b724c611b750e451d61",client_version:"5.1-8955-gf723043f"}])),n.send(JSON.stringify(["ai-review-connect",{uuid:e.uuid,game_id:Number(e.gameId),ai_review_id:e.aiReviewId}]))},n.onmessage=c=>{try{let i=JSON.parse(c.data);if(!Array.isArray(i))return;let[l,d]=i;l===e.uuid&&d?.metadata?.game_state&&(clearTimeout(s),n.close(),r(d.metadata))}catch(i){clearTimeout(s),n.close(),a(i)}},n.onerror=()=>{clearTimeout(s),n.close(),a(new Error("WebSocket error"))}})}async function O(e,t=null){let r=`ogs.ai.${e}`,a=I(r);if(a)return a;let n=await Le(),s=Array.isArray(t)?t:await H(e);if(!s.length)throw new Error("No AI reviews found for this game");let c=s[s.length-1],i={gameId:e,aiReviewId:c.id||c.ai_review_id,uuid:c.uuid},l=await Ee(i,n),d=l?.game_state?.moves?.length||0,u=Array.isArray(l?.scores)?l.scores:[],f=ne(u,d),p={gameId:e,metadata:l,scoreLosses:f};return P(r,p),p}function g(e,t){e.status&&(e.status.textContent=t)}function M(e,t){e.gamesStatus&&(e.gamesStatus.textContent=t)}function D(e,t){e.profileName.textContent=t.playerName||"Player loaded",e.profileMeta.textContent=t.playerId?`OGS ID ${t.playerId} \u2022 ${t.playerRank||"?"}`:"Enter a player URL to begin.",t.playerAvatar?e.profileAvatar.style.backgroundImage=`url(${t.playerAvatar})`:e.profileAvatar.style.backgroundImage=""}function ue(e,t){e.profileStats&&(e.profileStats.innerHTML="",t.forEach(r=>{let a=document.createElement("div");a.className="stat-card",a.innerHTML=`${r.label}<span>${r.value}</span>`,e.profileStats.appendChild(a)}))}function me(e,t){if(!e.phaseReport||!e.analysisSummary)return;let r=t.black?.phases?.total?.moves||0,a=t.white?.phases?.total?.moves||0,n=t.black?.games||0,s=t.white?.games||0;e.analysisSummary.innerHTML=`
        <div><strong>Games Analyzed:</strong> Black ${n} | White ${s}</div>
        <div><strong>Moves Analyzed:</strong> Black ${r} | White ${a}</div>
    `,e.phaseReport.innerHTML=Q.map(c=>{let i=t.black?.phases?.[c.id],l=t.white?.phases?.[c.id];return`
            <div class="phase-section">
                <div class="phase-title">--- ${c.id==="total"?"TOTAL":`${c.label.toUpperCase()} (B:${i?.moves||0} W:${l?.moves||0} moves)`} ---</div>
                ${z(i,l,"Accuracy (<0.5)","accuracy","%",100,"Accuracy = % of moves with score loss <= 0.5")}
                ${z(i,l,"AvgScoreLoss","avgLoss","",12)}
                ${z(i,l,"AvgWinLoss","avgWinLoss","%",50)}
                <div class="mistake-row">
                    <div>Black Mistakes: ${ce(i)}</div>
                    <div>White Mistakes: ${ce(l)}</div>
                </div>
            </div>
        `}).join(""),de(e.scoreDistribution,B,t.black?.phases?.total,t.white?.phases?.total,!0,"score"),de(e.winrateDistribution,T,t.black?.phases?.total,t.white?.phases?.total,!1,"winrate")}function z(e,t,r,a,n,s,c=""){let i=a?e?.[a]??0:0,l=a?t?.[a]??0:0,d=s?Math.min(100,i/s*100):0,u=s?Math.min(100,l/s*100):0;return`
        <div class="metric-row">
            <div class="metric-side left">
                <div class="metric-value">${i}${n}</div>
            </div>
            <div class="metric-center">
                <div class="metric-label" ${c?`title="${c}"`:""}>${r}</div>
                <div class="metric-bar-split">
                    <div class="metric-half left"><div class="metric-fill" style="width:${d}%"></div></div>
                    <div class="metric-half right"><div class="metric-fill" style="width:${u}%"></div></div>
                </div>
            </div>
            <div class="metric-side right">
                <div class="metric-value">${l}${n}</div>
            </div>
        </div>
    `}function ce(e){if(!e?.mistakes)return"0/0/0";let{total:t,severe:r,blunders:a}=e.mistakes;return`${t}/${r}/${a}`}function de(e,t,r,a,n,s){if(!e)return;let c=r?.moves||0,i=a?.moves||0,l=s==="winrate"?r?.winrateBuckets||{}:r?.scoreBuckets||{},d=s==="winrate"?a?.winrateBuckets||{}:a?.scoreBuckets||{};e.innerHTML=t.map(u=>{let f=l[u.id]||0,p=d[u.id]||0,y=c?f/c*100:0,v=i?p/i*100:0,A=n&&u.color||"#4fd1c5";return`
            <div class="dist-row">
                <div>
                    <div class="dist-bar left"><div class="dist-fill" style="width:${y}%; background:${A};"></div></div>
                    <div class="metric-value">${y.toFixed(1)}%</div>
                </div>
                <div class="dist-label">${u.label}</div>
                <div>
                    <div class="dist-bar right"><div class="dist-fill" style="width:${v}%; background:${A};"></div></div>
                    <div class="metric-value">${v.toFixed(1)}%</div>
                </div>
            </div>
        `}).join("")}function fe(e,t,r,a,n,s){if(!e.gamesTable)return;if(!t.length){e.gamesTable.innerHTML='<div class="status">No games to display for current filters.</div>';return}let c=t.map(i=>{let l=r.get(i.id),d=S(i,n),u=l?"Ready":a.get(i.id)||"Pending",f=X(i,n),p=f?b(f):"Unknown",y=k(f?.ranking||f?.rank),v=k((d==="black"?i.players?.black?.ranking:i.players?.white?.ranking)||null),A=d==="black"?`\u25CF ${v||""}`.trim():`\u26AA ${v||""}`.trim(),h=Z(i,n),L=h.startsWith("L+")?"pill danger":"pill success",ge=Y(i.ended||i.started),be=`${i.width||0}x${i.height||0}`,ke=i.handicap?String(i.handicap):"-";return`
            <tr>
                <td class="col-user">${A}</td>
                <td class="col-date">${ge}</td>
                <td class="col-opponent">${p}${y?` [${y}]`:""}</td>
                <td class="col-size">${be}</td>
                <td class="col-hc">${ke}</td>
                <td class="col-name">${i.name||E(i)}</td>
                <td class="col-result"><span class="${L}">${h}</span></td>
                <td class="col-analysis">${u}</td>
                <td class="col-viewer"><button class="small" data-game-id="${i.id}">Load</button></td>
            </tr>
        `}).join("");e.gamesTable.innerHTML=`
        <table>
            <thead>
                <tr>
                    <th class="col-user">User</th>
                    <th class="col-date">Date</th>
                    <th class="col-opponent">Opponent</th>
                    <th class="col-size">Size</th>
                    <th class="col-hc">HC</th>
                    <th class="col-name">Name</th>
                    <th class="col-result">Result</th>
                    <th class="col-analysis">Analysis</th>
                    <th class="col-viewer">Viewer</th>
                </tr>
            </thead>
            <tbody>${c}</tbody>
        </table>
    `,e.gamesTable.querySelectorAll("button[data-game-id]").forEach(i=>{i.addEventListener("click",()=>{let l=i.getAttribute("data-game-id");l&&s(l)})})}function j(e,t){!e.homeView||!e.viewerView||(e.homeView.classList.toggle("active",t==="home"),e.viewerView.classList.toggle("active",t==="viewer"))}function pe(e,t,r,a){if(e.viewerGameTitle&&(e.viewerGameTitle.textContent=r||"Game loaded"),e.viewerGameMeta&&(e.viewerGameMeta.textContent=t?`Accuracy ${t.phases.total.accuracy}%`:"AI data loaded"),e.viewerGameResult&&(e.viewerGameResult.textContent=a||"--"),!!e.viewerGameReport){if(!t){e.viewerGameReport.innerHTML='<div class="status">No analysis available.</div>';return}e.viewerGameReport.innerHTML=`
        <div class="report-block">
            <div><strong>Opening</strong> \u2022 ${t.phases.opening.accuracy}% accuracy</div>
            <div><strong>Middle</strong> \u2022 ${t.phases.middle.accuracy}% accuracy</div>
            <div><strong>End</strong> \u2022 ${t.phases.end.accuracy}% accuracy</div>
            <div>Average score loss: ${t.phases.total.avgLoss}</div>
        </div>
    `}}function U(e,t,r,a){if(!e.qualityTable)return;let s=t?.[r==="all"?"all":r]||{black:{},white:{}},c=Object.values(s.black||{}).reduce((d,u)=>d+u,0),i=Object.values(s.white||{}).reduce((d,u)=>d+u,0);if(e.qualityTable.innerHTML=B.map(d=>{let u=s.black?.[d.id]||0,f=s.white?.[d.id]||0,p=c?u/c*100:0,y=i?f/i*100:0;return`
            <div class="quality-row">
                <div class="metric-value">${d.label}</div>
                <div class="quality-line">
                    <div>Black</div>
                    <div class="bar"><div class="fill" style="width:${p}%; background:${d.color};"></div></div>
                    <div>${u}</div>
                </div>
                <div class="quality-line">
                    <div>White</div>
                    <div class="bar"><div class="fill" style="width:${y}%; background:${d.color};"></div></div>
                    <div>${f}</div>
                </div>
            </div>
        `}).join(""),!e.viewerGameReport)return;if(!a){e.viewerGameReport.innerHTML='<div class="status">No analysis available.</div>';return}let l=r==="all"?a.phases.total:a.phases[r];e.viewerGameReport.innerHTML=`
        <div class="report-block">
            <div><strong>${r.toUpperCase()}</strong> \u2022 ${l.accuracy}% accuracy</div>
            <div>Average score loss: ${l.avgLoss}</div>
            <div>Moves analyzed: ${l.moves}</div>
        </div>
    `}function V(e,t=19){let r=document.querySelector(".besogo-viewer");if(!r)return;let a=r.parentElement||document.body,n=r.style.height||"625px",s=r.style.width||"552px",c=r.getAttribute("panels")||"control+names",i=r.getAttribute("resize")||"fixed",l=document.createElement("div");l.className="besogo-viewer",l.style.height=n,l.style.width=s,l.setAttribute("resize",i),l.setAttribute("panels",c),l.setAttribute("size",String(t)),l.setAttribute("coord","none"),l.setAttribute("realstones","on"),l.setAttribute("shadows","auto"),a.replaceChild(l,r);try{besogo.autoInit(),e.editor=l.besogoEditor||null}catch(d){console.warn("Besogo init failed",d)}}function Te(e,t){if(!e.editor||!t)return;let r=t.players?.black||{},a=t.players?.white||{},n={PB:b(r),PW:b(a),BR:k(r?.ranking)||"?",WR:k(a?.ranking)||"?"};e.editor.setGameInfo(n)}function ve(e,t,r){let a=t.width||19,n=t.height||19;V(e,a);let s=e.editor;if(!s)return;let c=besogo.makeGameRoot(a,n),i=c,d=(t.initial_player||"black").toLowerCase()==="white"?1:-1;e.viewerNodesByMove=new Map,(t.moves||[]).forEach((u,f)=>{let p=i.makeChild(),y=(u.x??-1)>=0?u.x+1:0,v=(u.y??-1)>=0?u.y+1:0;p.playMove(y,v,d,!0),i.addChild(p),i=p,d=-d,e.viewerNodesByMove.set(f+1,{node:p,x:y,y:v})}),s.loadRoot(c),s.setCurrent(i),Te(e,r)}function ye(e,t){if(!t||!e.viewerNodesByMove)return;(t.scoreLosses||[]).forEach((a,n)=>{if(a==null)return;let s=e.viewerNodesByMove.get(n+1);if(!s||s.x<=0||s.y<=0)return;let c=G(a);s.node.addMarkup(s.x,s.y,{type:"analysis",color:c.color,label:c.label,value:a})}),e.editor?.refreshMarkup?.()}function Re(){let e=m.filterRanked?.checked,t=m.filterFree?.checked;return o.games.filter(r=>!!(r.ranked&&e||!r.ranked&&t))}function C(){D(m,o);let e=Re(),t=ie(e,o.analyses,o.playerId),r={total:e.length,ranked:e.filter(a=>a.ranked).length,free:e.filter(a=>!a.ranked).length};ue(m,[{label:"Total games",value:r.total},{label:"Ranked",value:r.ranked},{label:"Free",value:r.free},{label:"Wins",value:t.combined.wins},{label:"Losses",value:t.combined.losses},{label:"Accuracy",value:`${t.combined.phases.total.accuracy}%`}]),me(m,t),fe(m,e,o.analyses,o.analysisErrors,o.playerId,Ge),we()}function Me(){o.games=[],o.analyses=new Map,o.analysisErrors=new Map,o.selectedGameId=null}function q(e){return new Promise(t=>setTimeout(t,e))}async function Ie(e,t=50){let r=0,a=1,n=!0,s=m.filterRanked?.checked,c=m.filterFree?.checked,i=s&&!c?!0:!s&&c?!1:null;for(;r<t&&n;){let l=await le(e,a,{pageSize:25,ranked:i===null?void 0:i}),d=Array.isArray(l?.results)?l.results:[];for(let u of d){if(r>=t)break;if(u.width!==19||u.height!==19)continue;let f=[];try{f=await H(u.id)}catch{M(m,"Throttled on reviews. Waiting..."),await q(1e3);continue}if(f.length)try{let p=await O(u.id,f);o.games.push(u),o.analyses.set(u.id,p),r+=1,C(),M(m,`Analyzed ${r} of ${t}...`),await q(600)}catch(p){o.analysisErrors.set(u.id,p.message||"Analysis failed"),await q(600)}}n=!!l?.next,a+=1}}async function Pe(){let e=K(m.playerInput.value);if(!e){g(m,"Please enter a valid player URL or ID.");return}Me(),o.playerId=e,g(m,"Loading 19x19 AI-reviewed games...");try{o.games=[],o.analyses=new Map,o.analysisErrors=new Map,M(m,"Analyzing games one by one..."),await Ie(e,50)}catch(r){g(m,`Failed to load games: ${r.message}`);return}let t=o.games.find(r=>S(r,e));if(t){let a=S(t,e)==="black"?t.players?.black:t.players?.white;o.playerName=b(a);let n=k(a?.ranking||a?.rank);o.playerRank=n||"Unknown rank",o.playerAvatar=a?.icon||null}else o.playerName=`Player ${e}`,o.playerRank=null,o.playerAvatar=null;C(),M(m,`Loaded ${o.games.length} games.`),g(m,`Profile loaded for ${o.playerName||e}.`)}async function Ge(e){let t=o.games.find(n=>String(n.id)===String(e));if(!t)return;g(m,`Loading game ${e}...`);let r=o.analyses.get(t.id);if(!r)try{r=await O(t.id),o.analyses.set(t.id,r)}catch(n){g(m,`Failed to load game ${e}: ${n.message}`);return}let a=r.metadata?.game_state;if(a){ve(o,a,t),o.selectedGameId=t.id;let n=_(t,r,o.playerId);o.viewerReport=n,o.viewerQuality=se(r),o.viewerScores=Array.isArray(r.metadata?.scores)?r.metadata.scores:[],o.viewerWinrates=Array.isArray(r.metadata?.win_rates)?r.metadata.win_rates:[],o.viewerMovesLength=a.moves?.length||0,Ne(a.initial_player||"black"),ye(o,r),pe(m,n,E(t),R(t,o.playerId)),U(m,o.viewerQuality,o.viewerPhase,n),j(m,"viewer"),g(m,`Loaded game ${e}.`)}else g(m,`Missing game state for ${e}.`)}function Ne(e){!o.editor||o.editorListenerTarget===o.editor||(o.editorListenerTarget=o.editor,o.editor.addListener(t=>{if(t.navChange){let r=o.editor.getCurrent().moveNumber||0;he(r,e)}}),he(o.viewerMovesLength,e))}function he(e,t){if(!m.currentScore||!m.currentWinrate)return;let r=o.viewerScores.length>=o.viewerMovesLength+1,a=Math.max(0,Math.min(o.viewerScores.length-1,r?e:e-1)),n=o.viewerScores[a],s=o.viewerWinrates[a];m.currentScore.textContent=typeof n=="number"?n.toFixed(2):"--",m.currentWinrate.textContent=typeof s=="number"?`${(s*100).toFixed(1)}%`:"--"}function Ce(){j(m,"home")}function We(e){o.viewerPhase=e,m.analysisTabs&&m.analysisTabs.querySelectorAll(".tab").forEach(t=>{let r=t.dataset.phase===e;t.classList.toggle("active",r),t.setAttribute("tabindex",r?"0":"-1")}),U(m,o.viewerQuality,o.viewerPhase,o.viewerReport)}function _e(){m.loadPlayer?.addEventListener("click",Pe),m.clearSession?.addEventListener("click",()=>{ee(),g(m,"Session cache cleared.")}),m.filterRanked?.addEventListener("change",C),m.filterFree?.addEventListener("change",C),m.backToHome?.addEventListener("click",Ce),window.addEventListener("resize",we),m.analysisTabs?.addEventListener("click",e=>{let t=e.target.closest(".tab");if(!t)return;let r=t.dataset.phase||"all";We(r)})}function we(){let e=document.querySelector(".tables-panel"),t=document.querySelector(".games-panel");if(!e||!t)return;let r=e.getBoundingClientRect().height;r>0&&(t.style.height=`${r}px`)}_e();D(m,o);V(o,19);g(m,"Ready to load a player.");
